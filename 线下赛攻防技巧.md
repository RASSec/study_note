# 线下赛攻防技巧

## 一:信息收集

### 维护机器的信息

查看初始化脚本来获取数据库密码等信息

### 主机发现

#### nmap

•ICMP扫描：nmap  -sP 192.168.1.100-254

•尝试检测目标操作系统：-O

•SYN扫描：-sS

•操作系统版本检测：-sV

•AWD常用命令

​	nmap –sS –p 1337 172.16.0.0/24

#### routerscan

#### masscann

•root@VM-129-148-ubuntu:/home/ubuntu# masscan

•usage:

•masscan -p80,8000-8100 10.0.0.0/8 --rate=10000

•scan some web ports on 10.x.x.x at 10kpps

•masscan --nmap

•list those options that are compatible with nmap

•masscan -p80 10.0.0.0/8 --banners -oB <filename>

•save results of scan in binary format to <filename>

•masscan --open --banners --readscan <filename> -oX <savefile>

•read binary scan results in <filename> and save them as xml in <savefile>

## 二:信息备份



### crontab命令

#### 启动crontab服务

一定要确认crontab服务开启

```shell
service cron start
service cron stop
service cron restart
```

#### 开启crontab日志

crontab默认情况下是不执行开启日子的，所以一开始写完后，不能执行，想查看日志，却找不到。所以先开启定时任务的日志来查看

修改rsyslog服务，将 /etc/rsyslog.d/50-default.conf 文件中的 #cron.* 和#daedon.* 前的 # 删掉；

[![img](https://image.3001.net/images/20190820/1566265711_5d5b516f52d4c.png!small)](https://image.3001.net/images/20190820/1566265711_5d5b516f52d4c.png)

用以下命令重启rsyslog服务：



```
service rsyslog restart
```



然后再重启crontab服务：



```
service cron restart
```

### 1.Web目录备份

```shell
#!/bin/bash
backupdir=/tmp/backup
webdir=/var/www/html
tm=`date +%d%H%M`
mkdir -p $backupdir
cd $webdir && tar -zcvf $backupdir/$tm.tar.gz . 
```

```bash
crontab -e
10 * * * * ~/xxx.sh
```



### 2.Mysql 备份

#### mysql备份命令

```shell
mysqldump -u root -p --single-transaction --all-databasees > backup.sql # 所有数据库
mysqldump -u root -p --single-transaction dataname > backup.sql # 单个
 
 遇到加锁的情况:
 mysqldump --skip-lock-tables -u xxxx -p -h 166.111.9.173  -R urlevent20180319> backup.sql 
```

- 恢复mysql

`mysql -uroot -p TEST < bak.sql`

- 修改mysql密码

`update mysql.user set password=PASSWORD('skyboy') where user='root' and host='localhost'`

`flush privileges`

最好先修改mysql,再修改php,一般不存在需要修改mysql密码的情况

- 数据库降权

```mysql
CREATER USER 'dog'@'localhost' IDENTIFIED BY '123456';
GRANT ALL ON databasename.* TO 'dog'@'localhost';
flush privileges
```

然后修改站点配置文件,保证题目能连接数据库

- 其他命令

```mysql
drop database edusoho;#删库
update mysql.user set authentication_string=PASSWORD('hi23333');#修改所有用户密码
flush privileges;
UPDATE mysql.user `SET User='aaaaaaaa' where user='root'`;
flush privileges;
#降权
grant all on *.* to moxiaoxi@localhost identified by 'moxiaoxi';# 一句话完成具体权限修改all
grant select,update on dbname.* to username @'%' identified by 'password';
CREATE USER 'test'@'localhost' IDENTIFIED BY '123456';#create user 使用
flush privileges;
delete from mysql.user ;#删除所有用户
flush privileges
```



#### mysql备份脚本

```shell
#!/bin/bash
#mysq1备份脚本
#备份目录
backupDir=/home/backup/database
#mysqlDump
mysqldump=/usr/local/mariadb/bin/mysqldump
#ip
host=127.0.0.1
#用户名
username= root
password=42342342
#今天日期
today=`date +8Y8m%d`
#要备份的数据库数组
databases=(blog chinese medicine)
# echo $databaseCount
for database in ${databases[@]}
	do
		echo ' 开始备份'$database
		$mysqldump -h$host -u$username -p$password $database| gzip >$backupDir/$database-$today.sql.gz
echo '成功备份'$database'到$backupDir/ $database-stoday . sql.gzdone
	done


```

```shell
crontab -e
10 * * * * ~/sqlbak.sh
```



### 3.初始进程、端口与权限备份



**对于非必须可写的目录**，权限设置为755，拥有者设为非www-data用户；从而防止文件被篡改/删除。
需要文件读写的改成777**对于必须可写的目录**，根据服务器类型，上一个.htaccess,或者nginx的目录配
置文件，去除此路径的脚本执行权限。

```shell
find . -type d -writable | xargs chmod 755
```



### 4. 定时恢复

最好每隔30分钟删一次站,替换成最近的备份

```shell
#!/bin/bash
www_dir="/var/www/html"
backfile="latest.tar"
while true
do 
	rm -rf $www_dir/*
	tar xvzfp $backfile --directory=$www_dir/
	sleep 60
done
```

### 备份脚本

```shell
#!/bin/bash
backup=/home/backup
backupDir=${backup}/database
webbackupDir=${backup}/html
webrootdir=/opt/lampp/htdocs/
password=PickYourOwnPassword
mkdir -p $backupDir
mkdir -p $webbackupDir
mysqldump=/opt/lampp/bin/mysqldump
host=127.0.0.1
user=root
username=root
password=
today=`date +8Y8m%d`
databases=('babyblog')



# echo $databaseCount
for database in ${databases[@]}
        do
                echo 'start backup '$database
                $mysqldump -h$host -u$username --password="$password" babyblog | gzip > $backupDir/$database-$today.sql.gz
                echo 'successfully backup '$database' to '$backupDir'/'$database-$today' . sql.gzdone'
        done

tar -czf $webbackupDir/$today-website.tar.gz $webrootdir
chown $user:$user $backup/*
```



## 运维

### 杀内存马

假设存在内存马 shell.php

```shell
rm shell.php && mkdir shell.php #此时,内存马不能写了
ps -aux|grep "www-data"|awk '{print $2}'|xargs kill -9#权限足够时直接执行,若权限不够时,写一个shell来执行
rmdir shell.php
```

## tricks
### python脚本转为可执行文件

这里用到一个名为pyinstaller的库，安装很简单：pip install pyinstaller

使用也很简单：pyinstaller -F ./Monitor.py

